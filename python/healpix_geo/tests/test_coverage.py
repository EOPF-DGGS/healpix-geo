import numpy as np
import pytest

import healpix_geo.nested as healpix


@pytest.mark.parametrize(
    ["flat", "expected_ids", "expected_depths", "expected_coverage"],
    (
        pytest.param(
            False,
            np.array(
                [
                    0,
                    4,
                    5,
                    6,
                    7,
                    8,
                    9,
                    10,
                    11,
                    12,
                    13,
                    14,
                    15,
                    69,
                    70,
                    71,
                    76,
                    77,
                    79,
                    89,
                    90,
                    91,
                    92,
                    94,
                    95,
                ],
                dtype="uint64",
            ),
            np.array(
                [
                    1,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                ],
                dtype="u8",
            ),
            np.array(
                [
                    True,
                    True,
                    False,
                    True,
                    False,
                    True,
                    True,
                    False,
                    False,
                    True,
                    False,
                    False,
                    False,
                    False,
                    False,
                    True,
                    False,
                    False,
                    False,
                    False,
                    False,
                    True,
                    False,
                    False,
                    False,
                ]
            ),
        ),
        pytest.param(
            True,
            np.array(
                [
                    0,
                    1,
                    2,
                    3,
                    4,
                    5,
                    6,
                    7,
                    8,
                    9,
                    10,
                    11,
                    12,
                    13,
                    14,
                    15,
                    69,
                    70,
                    71,
                    76,
                    77,
                    79,
                    89,
                    90,
                    91,
                    92,
                    94,
                    95,
                ],
                dtype="uint64",
            ),
            np.array(
                [
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                ],
                dtype="u8",
            ),
            np.array(
                [
                    True,
                    True,
                    True,
                    True,
                    True,
                    False,
                    True,
                    False,
                    True,
                    True,
                    False,
                    False,
                    True,
                    False,
                    False,
                    False,
                    False,
                    False,
                    True,
                    False,
                    False,
                    False,
                    False,
                    False,
                    True,
                    False,
                    False,
                    False,
                ]
            ),
            id="flat",
        ),
    ),
)
def test_zone_coverage(flat, expected_ids, expected_depths, expected_coverage):
    zone = (0.0, 0.0, 90.0, 90.0)
    depth = 2

    cell_ids, depths, fully_covered = healpix.zone_coverage(
        zone, depth, ellipsoid="sphere", flat=flat
    )

    np.testing.assert_equal(cell_ids, expected_ids)
    np.testing.assert_equal(depths, expected_depths)
    np.testing.assert_equal(fully_covered, expected_coverage)
